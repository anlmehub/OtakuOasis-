â€OtakuOasis - Ultimate SinUltimategle File Monolithic Server
â€ * -----------------------------------------------------------
â€ * Features:
â€ * - Website + REST API in one Node.js script
â€ * - MongoDB optional (MONGODB_URI), fallback to in-memory demo
â€ * - Extended Anime schema: title, description, episodes, status, streamUrl, downloadUrl
â€ * - Auto preload popular anime if DB empty
â€ * - Owner panel: /owner/health.json, /owner/demo
â€ * - CORS enabled
â€ * - Simple add form on website
â€ */
â€
â€const express = require("express");
â€const cors = require("cors");
â€const os = require("os");
â€require("dotenv").config();
â€
â€const PORT = process.env.PORT || 5000;
â€const OWNER_TOKEN = process.env.OWNER_TOKEN || "";
â€const DEMO_AUTO_DELETE_MINUTES = parseInt(process.env.DEMO_AUTO_DELETE_MINUTES || "0", 10);
â€
â€let mongoose = null;
â€const hasMongo = !!process.env.MONGODB_URI;
â€if (hasMongo) {
â€Â  try { mongoose = require("mongoose"); } 
â€Â  catch (e) { console.warn("Install mongoose with npm i mongoose"); }
â€}
â€
â€const app = express();
â€app.use(cors());
â€app.use(express.json());
â€
â€/* -----------------------------
â€Â Â  Anime Data Layer
â€------------------------------*/
â€let AnimeModel = null;
â€let usingMemory = true;
â€let memoryStore = { anime: [] };
â€
â€async function initData() {
â€Â  if (hasMongo && mongoose) {
â€Â Â Â  try {
â€Â Â Â Â Â  await mongoose.connect(process.env.MONGODB_URI);
â€Â Â Â Â Â  const schema = new mongoose.Schema({
â€Â Â Â Â Â Â Â  title: { type: String, required: true },
â€Â Â Â Â Â Â Â  description: String,
â€Â Â Â Â Â Â Â  episodes: Number,
â€Â Â Â Â Â Â Â  status: { type: String, enum: ["Ongoing", "Completed"], default: "Ongoing" },
â€Â Â Â Â Â Â Â  streamUrl: String,
â€Â Â Â Â Â Â Â  downloadUrl: String,
â€Â Â Â Â Â Â Â  createdAt: { type: Date, default: Date.now },
â€Â Â Â Â Â  });
â€Â Â Â Â Â  AnimeModel = mongoose.model("Anime", schema);
â€Â Â Â Â Â  usingMemory = false;
â€
â€Â Â Â Â Â  // Preload popular anime if DB empty
â€Â Â Â Â Â  const count = await AnimeModel.countDocuments();
â€Â Â Â Â Â  if (count === 0) {
â€Â Â Â Â Â Â Â  const popular = [
â€Â Â Â Â Â Â Â Â Â  { title: "Naruto", description: "A young ninja strives to be the best.", episodes: 220, status: "Completed", streamUrl: "#", downloadUrl: "#" },
â€Â Â Â Â Â Â Â Â Â  { title: "One Piece", description: "Pirates, adventures, and the search for the One Piece.", episodes: 1100, status: "Ongoing", streamUrl: "#", downloadUrl: "#" },
â€Â Â Â Â Â Â Â Â Â  { title: "Attack on Titan", description: "Humans fight titans.", episodes: 87, status: "Completed", streamUrl: "#", downloadUrl: "#" },
â€Â Â Â Â Â Â Â Â Â  { title: "Demon Slayer", description: "A boy fights demons to save his sister.", episodes: 26, status: "Ongoing", streamUrl: "#", downloadUrl: "#" },
â€Â Â Â Â Â Â Â Â Â  { title: "My Hero Academia", description: "Superheroes in training.", episodes: 112, status: "Ongoing", streamUrl: "#", downloadUrl: "#" }
â€Â Â Â Â Â Â Â  ];
â€Â Â Â Â Â Â Â  await AnimeModel.insertMany(popular);
â€Â Â Â Â Â Â Â  console.log("âœ… Preloaded popular anime.");
â€Â Â Â Â Â  }
â€
â€Â Â Â Â Â  console.log("âœ… MongoDB connected. Using Mongo storage.");
â€Â Â Â  } catch (err) {
â€Â Â Â Â Â  usingMemory = true;
â€Â Â Â Â Â  console.warn("âš ï¸ Mongo connection failed, using in-memory demo store.");
â€Â Â Â  }
â€Â  } else {
â€Â Â Â  usingMemory = true;
â€Â Â Â  memoryStore.anime = [
â€Â Â Â Â Â  { _id: "mem-1", title: "Naruto", description: "A young ninja strives to be the best.", episodes: 220, status: "Completed", streamUrl: "#", downloadUrl: "#", createdAt: new Date().toISOString() },
â€Â Â Â Â Â  { _id: "mem-2", title: "One Piece", description: "Pirates, adventures, and the search for the One Piece.", episodes: 1100, status: "Ongoing", streamUrl: "#", downloadUrl: "#", createdAt: new Date().toISOString() },
â€Â Â Â  ];
â€Â Â Â  console.log("â„¹ï¸ Using in-memory demo store.");
â€Â  }
â€
â€Â  if (usingMemory && DEMO_AUTO_DELETE_MINUTES > 0) {
â€Â Â Â  setInterval(() => { memoryStore.anime = []; console.log("ğŸ§¹ In-memory demo auto-cleared."); }, DEMO_AUTO_DELETE_MINUTES * 60 * 1000);
â€Â  }
â€}
â€initData();
â€
â€/* -----------------------------
â€Â Â  Helpers
â€------------------------------*/
â€function isOwner(req) {
â€Â  const auth = (req.headers.authorization || "").replace("Bearer ", "");
â€Â  if (OWNER_TOKEN && auth === OWNER_TOKEN) return true;
â€Â  if (OWNER_TOKEN && req.query.owner === OWNER_TOKEN) return true;
â€Â  const ip = req.ip || req.connection?.remoteAddress || "";
â€Â  const isLocal = ip.includes("127.0.0.1") || ip.includes("::1") || req.hostname === "localhost";
â€Â  return !OWNER_TOKEN && isLocal;
â€}
â€
â€function healthSnapshot() {
â€Â  const uptime = os.uptime();
â€Â  const load = os.loadavg().map((n) => Number(n).toFixed(2));
â€Â  const total = os.totalmem();
â€Â  const free = os.freemem();
â€Â  const used = total - free;
â€Â  const mem = { totalGB: (total / 1024 / 1024 / 1024).toFixed(2), usedGB: (used / 1024 / 1024 / 1024).toFixed(2), usagePct: ((used / total) * 100).toFixed(2)+"%" };
â€Â  return { uptime, load, mem, node: process.version };
â€}
â€
â€/* -----------------------------
â€Â Â  API Routes
â€------------------------------*/
â€// GET all anime
â€app.get("/api/anime", async (req, res) => {
â€Â  try {
â€Â Â Â  if (usingMemory) return res.json(memoryStore.anime);
â€Â Â Â  const all = await AnimeModel.find().sort({ createdAt: -1 });
â€Â Â Â  res.json(all);
â€Â  } catch (e) { res.status(500).json({ error: "Failed to fetch anime." }); }
â€});
â€
â€// POST new anime
â€app.post("/api/anime", async (req, res) => {
â€Â  try {
â€Â Â Â  const { title, description = "", episodes = 0, status = "Ongoing", streamUrl = "#", downloadUrl = "#" } = req.body || {};
â€Â Â Â  if (!title) return res.status(400).json({ error: "title is required" });
â€
â€Â Â Â  if (usingMemory) {
â€Â Â Â Â Â  const item = { _id: "mem-"+Math.random().toString(36).slice(2), title, description, episodes: Number(episodes), status, streamUrl, downloadUrl, createdAt: new Date().toISOString() };
â€Â Â Â Â Â  memoryStore.anime.unshift(item);
â€Â Â Â Â Â  return res.json(item);
â€Â Â Â  } else {
â€Â Â Â Â Â  const created = await AnimeModel.create({ title, description, episodes, status, streamUrl, downloadUrl });
â€Â Â Â Â Â  return res.json(created);
â€Â Â Â  }
â€Â  } catch (e) { res.status(500).json({ error: "Failed to create anime." }); }
â€});
â€
â€/* -----------------------------
â€Â Â  Owner Endpoints
â€------------------------------*/
â€app.get("/owner/health.json", (req, res) => {
â€Â  if (!isOwner(req)) return res.status(403).json({ error: "Forbidden" });
â€Â  res.json(healthSnapshot());
â€});
â€
â€app.delete("/owner/demo", (req, res) => {
â€Â  if (!isOwner(req)) return res.status(403).json({ error: "Forbidden" });
â€Â  if (usingMemory) { memoryStore.anime = []; return res.json({ ok: true, cleared: true, storage: "memory" }); }
â€Â  return res.json({ ok: false, message: "Mongo demo purge not implemented." });
â€});
â€
â€/* -----------------------------
â€Â Â  Website (HTML + CSS + JS)
â€------------------------------*/
â€const HTML = `<!doctype html>
â€<html lang="en">
â€<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1" /><title>OtakuOasis</title>
â€<style>
â€Â  body{margin:0;font-family:system-ui;background:#0b0b14;color:#f2f2f7;}header{padding:16px;display:flex;justify-content:space-between;}a{color:#f2f2f7;text-decoration:none;margin-left:10px;}main{max-width:960px;margin:20px auto;padding:0 16px;} .anime-item{border:1px solid rgba(255,255,255,0.1);padding:12px;margin-bottom:12px;border-radius:10px;}
â€Â  .badge{padding:2px 6px;border-radius:8px;font-size:12px;margin-left:6px;}
â€Â  .badge.ok{background:#10b981;color:#fff;}
â€Â  .badge.warn{background:#f59e0b;color:#fff;}
â€</style></head>
â€<body>
â€<header><div>OtakuOasis</div><nav><a href="#list">Anime List</a><a href="#add">Add Anime</a><a href="#owner">Owner</a></nav></header>
â€<main>
â€<section id="list"><h2>Anime List</h2><div id="animeList"></div></section>
â€<section id="add"><h2>Add New Anime</h2><form id="form">
â€<input name="title" placeholder="Title *" required/><input name="episodes" type="number" placeholder="Episodes"/><input name="status" placeholder="Status"/><input name="streamUrl" placeholder="Stream URL"/><input name="downloadUrl" placeholder="Download URL"/><textarea name="description" placeholder="Description"></textarea><button type="submit">Add Anime</button></form></section>
â€<section id="owner"><h2>Owner Tools</h2><input id="ownerToken" placeholder="OWNER_TOKEN"/><button id="btnHealth">Health</button><button id="btnPurge">Purge Demo</button><pre id="health"></pre></section>
â€</main>
â€<script>
â€async function loadAnime(){const res=await fetch('/api/anime');const data=await res.json();const el=document.getElementById('animeList');el.innerHTML='';data.forEach(a=>{const div=document.createElement('div');div.className='anime-item';div.innerHTML='<strong>'+a.title+'</strong> <span class="badge '+(a.status==='Completed'?'ok':'warn')+'">'+a.status+'</span><br>'+a.description+'<br>Episodes: '+a.episodes+'<br><a href="'+a.streamUrl+'" target="_blank">Stream</a> | <a href="'+a.downloadUrl+'" target="_blank">Download</a>';el.appendChild(div);});}
â€document.getElementById('form').addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(e.target);const body={title:fd.get('title'),episodes:Number(fd.get('episodes')||0),status:fd.get('status')||'Ongoing',description:fd.get('description')||'',streamUrl:fd.get('streamUrl')||'#',downloadUrl:fd.get('downloadUrl')||'#'};await fetch('/api/anime',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});e.target.reset();loadAnime();});document.getElementById('btnHealth').addEventListener('click',async()=>{const token=document.getElementById('ownerToken').value;const res=await fetch('/owner/health.json'+(token?'?owner='+encodeURIComponent(token):''),{headers:token?{Authorization:'Bearer '+token}:{}});document.getElementById('health').textContent=res.ok?JSON.stringify(await res.json(),null,2):'Forbidden'});document.getElementById('btnPurge').addEventListener('click',async()=>{const token=document.getElementById('ownerToken').value;await fetch('/owner/demo'+(token?'?owner='+encodeURIComponent(token):''),{method:'DELETE',headers:token?{Authorization:'Bearer '+token}:{}});loadAnime();alert('Demo purged');});document.addEventListener('DOMContentLoaded',loadAnime);
â€</script>
â€</body>
â€</html>`;
â€
â€app.get("/", (req, res) => res.status(200).send(HTML));
â€
â€/* -----------------------------
â€Â Â  Start Server
â€------------------------------*/
â€app.listen(PORT, () => {
â€Â  console.log(`ğŸš€ OtakuOasis running on http://localhost:${PORT}`);
â€Â  if (OWNER_TOKEN) console.log("ğŸ”’ Owner token set. Use header: Authorization: Bearer " + OWNER_TOKEN);
â€Â  else console.log("â„¹ï¸ No OWNER_TOKEN set. Owner actions allowed from localhost only.");
â€});
â€
